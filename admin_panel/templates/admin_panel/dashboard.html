{% extends "admin_panel/base_admin.html" %}

{% block title %}Admin Dashboard - Student Portal{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Staff Overview</h1>
</div>

<div class="grid" style="gap: 1rem; margin-bottom: 2rem;">
    <div class="card" style="text-align: center; padding: 1.5rem; border-bottom: 4px solid var(--admin-dark);">
        <h3 style="margin: 0; color: #666; font-size: 0.9rem; text-transform: uppercase;">Total Entries</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0;">{{ counts.total }}</p>
    </div>
    <div class="card" style="text-align: center; padding: 1.5rem; border-bottom: 4px solid #007bff;">
        <h3 style="margin: 0; color: #666; font-size: 0.9rem; text-transform: uppercase;">Awaiting Review</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0;">{{ counts.pending }}</p>
    </div>
    <div class="card" style="text-align: center; padding: 1.5rem; border-bottom: 4px solid #28a745;">
        <h3 style="margin: 0; color: #666; font-size: 0.9rem; text-transform: uppercase;">Approved</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0;">{{ counts.approved }}</p>
    </div>
    <div class="card" style="text-align: center; padding: 1.5rem; border-bottom: 4px solid #ffc107;">
        <h3 style="margin: 0; color: #666; font-size: 0.9rem; text-transform: uppercase;">On Hold</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0;">{{ counts.hold }}</p>
    </div>
</div>

<div class="card">
    <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">Recent Registrations</h3>
        <div style="display: flex; gap: 1rem;">
            <a href="{% url 'admin_panel:exam_list' %}" class="btn btn-outline" style="padding: 0.5rem 1rem;">Manage Exams</a>
        </div>
    </div>

    <div class="table-responsive">
        <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--light-gray); text-align: left;">
                <th style="padding: 1rem;">Student</th>
                <th style="padding: 1rem;">Exam</th>
                <th style="padding: 1rem;">Date</th>
                <th style="padding: 1rem;">Document</th>
                <th style="padding: 1rem;">Status</th>
                <th style="padding: 1rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for reg in registrations %}
            <tr style="border-bottom: 1px solid var(--light-gray);">
                <td style="padding: 1rem;">{{ reg.student.email }}</td>
                <td style="padding: 1rem;">{{ reg.exam.name }}</td>
                <td style="padding: 1rem;">{{ reg.registered_at|date:"M j, Y" }}</td>
                <td style="padding: 1rem;">
                    {% if reg.document %}
                    <a href="{{ reg.document.url }}" target="_blank" style="color: var(--primary-red);">File</a>
                    {% else %}
                    <span style="color: #666; font-style: italic; font-size: 0.8rem;">No Doc</span>
                    {% endif %}
                </td>
                <td style="padding: 1rem;">
                    <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold; 
                            {% if reg.status == 'Approved' %} background: #d4edda; color: #155724; 
                            {% elif reg.status == 'Rejected' %} background: #f8d7da; color: #721c24; 
                            {% elif reg.status == 'Hold' %} background: #fff3cd; color: #856404; 
                            {% else %} background: #e9ecef; color: #495057; {% endif %}">
                        {{ reg.status }}
                    </span>
                    {% if reg.registration_number %}
                    <div style="font-size: 0.7rem; margin-top: 5px; color: #555;">{{ reg.registration_number }}</div>
                    {% endif %}
                </td>
                <td style="padding: 1rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            <a href="{% url 'admin_panel:registration_detail' reg.id %}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--black); border-color: var(--black);">View</a>
                            
                            {% if reg.status != 'Approved' %}
                            <form action="{% url 'admin_panel:update_registration_status' reg.id 'Approved' %}" method="POST">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: #155724; border-color: #155724;">
                                    {% if reg.status == 'Hold' %}Re-Approve{% else %}Approve{% endif %}
                                </button>
                            </form>
                            {% endif %}
                            
                            {% if reg.status == 'Approved' %}
                            <button type="button" onclick="document.getElementById('hold-form-{{ reg.id }}').style.display='block'; this.style.display='none'; document.getElementById('reject-btn-{{ reg.id }}').style.display='none';" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: #856404; border-color: #856404;">Hold</button>
                            {% endif %}
                            
                            {% if reg.status != 'Rejected' and reg.status != 'Approved' %}
                            <button type="button" id="reject-btn-{{ reg.id }}" onclick="document.getElementById('reject-form-{{ reg.id }}').style.display='block'; this.style.display='none'; if(document.querySelector('#hold-form-{{ reg.id }}')) document.querySelector('[onclick*=\'hold-form-{{ reg.id }}\']').style.display='none';" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: #721c24; border-color: #721c24;">Reject</button>
                            {% endif %}

                            <form action="{% url 'admin_panel:delete_registration' reg.id %}" method="POST" onsubmit="return confirm('Are you sure you want to delete this registration?');" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--primary-red);">Delete</button>
                            </form>
                        </div>

                        <!-- Hidden Hold Form -->
                        {% if reg.status == 'Approved' %}
                        <div id="hold-form-{{ reg.id }}" style="display: none; margin-top: 0.5rem;">
                            <form action="{% url 'admin_panel:update_registration_status' reg.id 'Hold' %}" method="POST" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                {% csrf_token %}
                                <input type="text" name="rejection_reason" placeholder="Reason for hold..." required style="padding: 0.25rem; font-size: 0.75rem;">
                                <div style="display: flex; gap: 0.25rem;">
                                    <button type="submit" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #856404;">Confirm Hold</button>
                                    <button type="button" onclick="document.getElementById('hold-form-{{ reg.id }}').style.display='none'; document.querySelector('[onclick*=\'hold-form-{{ reg.id }}\']').style.display='block'; document.getElementById('reject-btn-{{ reg.id }}').style.display='block';" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;">Cancel</button>
                                </div>
                            </form>
                        </div>
                        {% endif %}

                        <!-- Hidden Reject Form -->
                        <div id="reject-form-{{ reg.id }}" style="display: none; margin-top: 0.5rem;">
                            <form action="{% url 'admin_panel:update_registration_status' reg.id 'Rejected' %}" method="POST" style="display: flex; flex-direction: column; gap: 0.25rem;">
                                {% csrf_token %}
                                <input type="text" name="rejection_reason" placeholder="Reason for rejection..." required style="padding: 0.25rem; font-size: 0.75rem;">
                                <div style="display: flex; gap: 0.25rem;">
                                    <button type="submit" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #721c24;">Confirm Reject</button>
                                    <button type="button" onclick="document.getElementById('reject-form-{{ reg.id }}').style.display='none'; document.getElementById('reject-btn-{{ reg.id }}').style.display='block'; if(document.querySelector('[onclick*=\'hold-form-{{ reg.id }}\']')) document.querySelector('[onclick*=\'hold-form-{{ reg.id }}\']').style.display='block';" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: var(--dark-gray);">
                    No registrations found.
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
</div>
{% endblock %}